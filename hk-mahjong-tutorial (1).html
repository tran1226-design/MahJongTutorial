<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hong Kong Mahjong Scoring Guide</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --red: #C0392B;
    --deep-red: #8B1A1A;
    --gold: #D4A843;
    --gold-light: #F0CC72;
    --dark: #0F0A06;
    --dark-2: #1A1008;
    --dark-3: #231508;
    --paper: #F5E6C8;
    --paper-dim: #E8D4A8;
    --ink: #1A0A00;
    --ivory: #FDF6E3;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background-color: var(--dark);
    color: var(--paper);
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 17px;
    line-height: 1.7;
    min-height: 100vh;
    background-image: 
      radial-gradient(ellipse at 20% 10%, rgba(192,57,43,0.12) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, rgba(212,168,67,0.08) 0%, transparent 50%),
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23D4A843' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }

  .hero {
    text-align: center;
    padding: 70px 20px 50px;
    position: relative;
    overflow: hidden;
  }

  .hero::before {
    content: 'ğŸ€„';
    position: absolute;
    font-size: 300px;
    opacity: 0.04;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  .hero-eyebrow {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    letter-spacing: 0.35em;
    color: var(--gold);
    text-transform: uppercase;
    margin-bottom: 16px;
    opacity: 0.9;
  }

  .hero h1 {
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(2.2rem, 5vw, 3.8rem);
    font-weight: 700;
    color: var(--ivory);
    line-height: 1.15;
    margin-bottom: 12px;
  }

  .hero h1 span {
    color: var(--gold);
  }

  .hero-sub {
    font-style: italic;
    color: var(--paper-dim);
    opacity: 0.75;
    font-size: 1.15rem;
    max-width: 500px;
    margin: 0 auto;
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 16px;
    max-width: 700px;
    margin: 30px auto;
    padding: 0 20px;
  }

  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity: 0.4;
  }

  .divider-icon {
    color: var(--gold);
    font-size: 1.2rem;
    opacity: 0.7;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 0 20px 80px;
  }

  /* NAV TABS */
  .tab-nav {
    display: flex;
    gap: 4px;
    margin-bottom: 32px;
    background: rgba(255,255,255,0.04);
    border-radius: 12px;
    padding: 6px;
    border: 1px solid rgba(212,168,67,0.15);
    flex-wrap: wrap;
  }

  .tab-btn {
    flex: 1;
    min-width: 100px;
    background: transparent;
    border: none;
    color: var(--paper-dim);
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.25s ease;
    white-space: nowrap;
    text-align: center;
  }

  .tab-btn:hover {
    color: var(--gold-light);
    background: rgba(212,168,67,0.08);
  }

  .tab-btn.active {
    background: linear-gradient(135deg, var(--deep-red), var(--red));
    color: var(--ivory);
    box-shadow: 0 2px 12px rgba(192,57,43,0.4);
  }

  /* PANELS */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; animation: fadeUp 0.35s ease; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* SECTION HEADERS */
  .section-title {
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    color: var(--gold);
    text-transform: uppercase;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(212,168,67,0.2);
  }

  /* CARDS */
  .card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(212,168,67,0.15);
    border-radius: 14px;
    padding: 24px 28px;
    margin-bottom: 20px;
    transition: border-color 0.2s;
  }

  .card:hover { border-color: rgba(212,168,67,0.3); }

  .card-title {
    font-family: 'Noto Serif SC', serif;
    font-size: 1.15rem;
    color: var(--gold-light);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .fan-badge {
    background: linear-gradient(135deg, var(--deep-red), var(--red));
    color: var(--ivory);
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    padding: 3px 9px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .fan-badge.limit {
    background: linear-gradient(135deg, #7B2D00, #B34500);
  }

  .card p { color: var(--paper-dim); font-size: 0.97rem; }

  /* HIGHLIGHTED CARD */
  .card.highlight {
    border-color: rgba(192,57,43,0.4);
    background: rgba(192,57,43,0.06);
  }

  /* FAN TABLE */
  .fan-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }

  .fan-table th {
    font-family: 'Cinzel', serif;
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    color: var(--gold);
    text-align: left;
    padding: 10px 16px;
    border-bottom: 1px solid rgba(212,168,67,0.2);
  }

  .fan-table td {
    padding: 9px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    color: var(--paper-dim);
    vertical-align: middle;
  }

  .fan-table tr:hover td { background: rgba(255,255,255,0.03); }

  .pts {
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    color: var(--gold-light);
    font-weight: 600;
  }

  .fan-num {
    font-family: 'Cinzel', serif;
    color: var(--paper);
    font-size: 1rem;
  }

  tr.limit-row td { color: var(--gold); font-style: italic; }

  /* PAYMENT EXPLAINER */
  .payment-box {
    background: rgba(192,57,43,0.08);
    border: 1px solid rgba(192,57,43,0.3);
    border-radius: 12px;
    padding: 20px 24px;
    margin-bottom: 20px;
  }

  .payment-box h3 {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    letter-spacing: 0.2em;
    color: var(--red);
    margin-bottom: 12px;
    text-transform: uppercase;
  }

  /* CALCULATOR */
  .calc-wrap {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(212,168,67,0.2);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
  }

  .calc-label {
    font-family: 'Cinzel', serif;
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    color: var(--gold);
    text-transform: uppercase;
    margin-bottom: 12px;
    display: block;
  }

  .fan-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 24px;
  }

  .fan-chip {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(212,168,67,0.2);
    color: var(--paper-dim);
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    padding: 8px 16px;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }

  .fan-chip:hover { border-color: var(--gold); color: var(--gold-light); }
  .fan-chip.selected {
    background: linear-gradient(135deg, var(--deep-red), var(--red));
    border-color: var(--red);
    color: var(--ivory);
  }

  .win-method-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 24px;
  }

  .toggle-btn {
    flex: 1;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(212,168,67,0.2);
    color: var(--paper-dim);
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-style: italic;
  }

  .toggle-btn.selected {
    background: rgba(212,168,67,0.12);
    border-color: var(--gold);
    color: var(--gold-light);
  }

  .calc-result {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 20px 24px;
    border-left: 3px solid var(--gold);
  }

  .result-main {
    font-family: 'Cinzel', serif;
    font-size: 1.8rem;
    color: var(--gold-light);
    margin-bottom: 6px;
  }

  .result-breakdown {
    font-size: 0.92rem;
    color: var(--paper-dim);
    font-style: italic;
  }

  /* EXAMPLE HAND */
  .hand-example {
    background: rgba(0,0,0,0.25);
    border-radius: 12px;
    padding: 20px 24px;
    margin-bottom: 16px;
    border: 1px solid rgba(255,255,255,0.07);
  }

  .tile-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 10px 0;
  }

  .tile {
    background: var(--ivory);
    color: var(--ink);
    width: 38px;
    height: 50px;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    box-shadow: 0 3px 8px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.8);
    font-family: 'Noto Serif SC', serif;
    position: relative;
    transition: transform 0.15s;
  }

  .tile:hover { transform: translateY(-3px); }

  .tile.bamboo { color: #1a6b1a; }
  .tile.circle { color: #1a3a8b; }
  .tile.character { color: var(--red); }
  .tile.honor { color: #6b1a6b; }
  .tile.flower { color: #c07000; background: #fffbe8; }

  .tile-label {
    font-size: 0.48rem;
    opacity: 0.5;
    margin-top: 1px;
    font-family: 'Cinzel', serif;
    letter-spacing: 0;
  }

  .meld-group {
    display: flex;
    gap: 3px;
    align-items: flex-end;
  }

  .meld-group + .meld-group { margin-left: 10px; }

  .hand-score-breakdown {
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }

  .score-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 0.92rem;
    color: var(--paper-dim);
  }

  .score-line .pts-small {
    font-family: 'Cinzel', serif;
    color: var(--gold);
    font-size: 0.85rem;
  }

  .score-total {
    display: flex;
    justify-content: space-between;
    padding: 10px 0 0;
    margin-top: 6px;
    border-top: 1px solid rgba(212,168,67,0.3);
    font-family: 'Cinzel', serif;
    color: var(--gold-light);
  }

  /* GLOSSARY */
  .gloss-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 14px;
  }

  .gloss-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(212,168,67,0.12);
    border-radius: 10px;
    padding: 16px 18px;
  }

  .gloss-term {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    color: var(--gold);
    letter-spacing: 0.08em;
    margin-bottom: 4px;
  }

  .gloss-chinese {
    font-family: 'Noto Serif SC', serif;
    font-size: 0.9rem;
    color: var(--paper-dim);
    margin-bottom: 6px;
    opacity: 0.7;
  }

  .gloss-desc {
    font-size: 0.9rem;
    color: rgba(245,230,200,0.65);
    line-height: 1.5;
  }

  /* TIP BOX */
  .tip {
    background: rgba(212,168,67,0.07);
    border: 1px solid rgba(212,168,67,0.2);
    border-radius: 10px;
    padding: 14px 18px;
    font-size: 0.92rem;
    color: var(--paper-dim);
    margin-top: 16px;
    font-style: italic;
  }

  .tip::before {
    content: 'âœ¦ ';
    color: var(--gold);
    font-style: normal;
  }

  /* ============ CALCULATOR ============ */
  .calc-section-label {
    font-family: 'Cinzel', serif;
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    color: var(--gold);
    text-transform: uppercase;
    margin: 20px 0 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .hand-count-badge {
    background: rgba(192,57,43,0.3);
    color: var(--paper);
    font-size: 0.6rem;
    padding: 2px 8px;
    border-radius: 10px;
    border: 1px solid rgba(192,57,43,0.4);
    letter-spacing: 0.05em;
  }

  .tile-palette {
    background: rgba(0,0,0,0.2);
    border: 1px solid rgba(212,168,67,0.15);
    border-radius: 14px;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .palette-row {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .suit-label {
    font-family: 'Cinzel', serif;
    font-size: 0.55rem;
    letter-spacing: 0.1em;
    width: 62px;
    flex-shrink: 0;
    text-align: right;
    text-transform: uppercase;
    opacity: 0.8;
  }
  .char-label   { color: #e87070; }
  .bam-label    { color: #70c870; }
  .dot-label    { color: #7090e8; }
  .honor-label  { color: #c870c8; }
  .flower-label { color: #e8b040; }

  .palette-tiles {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }

  .p-tile {
    display: inline-block;
    width: 40px;
    height: 52px;
    background: linear-gradient(160deg, #fffef8 0%, #f2e8d0 100%);
    border-radius: 5px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.9), 2px 2px 0 rgba(0,0,0,0.2);
    border: 1px solid rgba(0,0,0,0.1);
    cursor: grab;
    transition: transform 0.12s, box-shadow 0.12s;
    user-select: none;
    position: relative;
    overflow: hidden;
    vertical-align: bottom;
  }

  .p-tile:hover {
    transform: translateY(-6px) scale(1.08);
    box-shadow: 0 8px 16px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.9), 2px 2px 0 rgba(0,0,0,0.15);
    z-index: 5;
  }

  .p-tile:active { transform: scale(0.95); cursor: grabbing; }

  .p-tile.dragging {
    opacity: 0.4;
    transform: scale(0.95);
  }

  /* Hand zone */
  .hand-zone {
    background: rgba(0,0,0,0.25);
    border: 2px dashed rgba(212,168,67,0.3);
    border-radius: 14px;
    min-height: 90px;
    padding: 14px 16px;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
  }

  .hand-zone.drag-over {
    border-color: var(--gold);
    background: rgba(212,168,67,0.06);
  }

  .hand-tiles-row {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    min-height: 58px;
    align-items: flex-end;
  }

  .hand-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-style: italic;
    color: rgba(245,230,200,0.3);
    font-size: 0.9rem;
    pointer-events: none;
    white-space: nowrap;
    text-align: center;
  }

  .h-tile {
    display: inline-block;
    width: 40px;
    height: 52px;
    background: linear-gradient(160deg, #fffef8 0%, #f2e8d0 100%);
    border-radius: 5px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.9), 2px 2px 0 rgba(0,0,0,0.2);
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.12s;
    user-select: none;
    position: relative;
    overflow: hidden;
    vertical-align: bottom;
  }

  .h-tile:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 12px rgba(192,57,43,0.4), inset 0 1px 0 rgba(255,255,255,0.9);
  }

  .h-tile:hover::after {
    content: 'âœ•';
    position: absolute;
    top: 2px; right: 3px;
    font-size: 8px;
    color: var(--red);
    font-style: normal;
    font-family: sans-serif;
    font-weight: bold;
    z-index: 10;
  }

  .h-tile.flower {
    background: linear-gradient(160deg, #fffbec 0%, #fdf0c8 100%);
  }

  .h-tile.flower-sep {
    border-left: 2px solid rgba(212,168,67,0.4);
    margin-left: 8px;
  }

  /* Tile group dividers in hand */
  .hand-divider {
    width: 1px;
    background: rgba(212,168,67,0.25);
    height: 52px;
    margin: 0 4px;
    align-self: flex-end;
  }

  .clear-btn {
    background: rgba(192,57,43,0.1);
    border: 1px solid rgba(192,57,43,0.3);
    color: var(--paper-dim);
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    padding: 7px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .clear-btn:hover { background: rgba(192,57,43,0.25); color: var(--ivory); }

  /* Settings */
  .calc-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 14px;
    background: rgba(0,0,0,0.15);
    border: 1px solid rgba(212,168,67,0.12);
    border-radius: 12px;
    padding: 16px 18px;
  }

  .setting-group { display: flex; flex-direction: column; gap: 7px; }

  .setting-label {
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    color: var(--gold);
    opacity: 0.8;
    text-transform: uppercase;
  }

  .setting-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }

  .pill {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(212,168,67,0.18);
    color: var(--paper-dim);
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.88rem;
    padding: 5px 10px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
  }

  .pill:hover { border-color: var(--gold); color: var(--gold-light); }

  .pill.selected {
    background: rgba(212,168,67,0.18);
    border-color: var(--gold);
    color: var(--gold-light);
  }

  /* Calc output */
  .calc-output {
    margin-top: 20px;
    background: rgba(0,0,0,0.25);
    border-radius: 14px;
    border: 1px solid rgba(212,168,67,0.15);
    padding: 20px 22px;
    min-height: 80px;
  }

  .calc-output-placeholder {
    text-align: center;
    font-style: italic;
    color: rgba(245,230,200,0.3);
    font-size: 0.95rem;
    padding: 12px 0;
  }

  .calc-invalid {
    text-align: center;
    color: rgba(245,100,80,0.7);
    font-style: italic;
    font-size: 0.95rem;
    padding: 8px 0;
  }

  .fan-breakdown {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 14px;
  }

  .fan-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 0.92rem;
    color: var(--paper-dim);
  }

  .fan-row-val {
    font-family: 'Cinzel', serif;
    font-size: 0.82rem;
    color: var(--gold);
    white-space: nowrap;
    margin-left: 12px;
  }

  .fan-row-val.limit { color: #e87050; }

  .score-summary {
    background: rgba(212,168,67,0.07);
    border: 1px solid rgba(212,168,67,0.25);
    border-radius: 10px;
    padding: 14px 18px;
    margin-top: 8px;
  }

  .score-big {
    font-family: 'Cinzel', serif;
    font-size: 1.6rem;
    color: var(--gold-light);
    margin-bottom: 4px;
  }

  .score-sub {
    font-size: 0.88rem;
    color: var(--paper-dim);
    font-style: italic;
  }

  .score-payment {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(212,168,67,0.2);
    font-size: 0.9rem;
    color: var(--paper-dim);
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .score-payment-line {
    display: flex;
    justify-content: space-between;
  }

  .score-payment-line strong {
    color: var(--gold-light);
    font-family: 'Cinzel', serif;
    font-size: 0.85rem;
  }

  /* UNICODE TILE STYLES */
  .utile-row {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: flex-end;
    margin: 10px 0 4px;
  }

  .meld-wrap {
    display: flex;
    gap: 3px;
    align-items: flex-end;
    margin-right: 10px;
    position: relative;
  }

  .meld-wrap + .meld-wrap { margin-left: 4px; }

  .meld-label {
    font-family: 'Cinzel', serif;
    font-size: 0.52rem;
    letter-spacing: 0.05em;
    color: var(--gold);
    text-align: center;
    margin-top: 5px;
    opacity: 0.8;
  }

  .meld-col {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .utile {
    display: inline-block;
    width: 44px;
    height: 58px;
    background: linear-gradient(160deg, #fffef8 0%, #f5edd8 100%);
    border-radius: 6px;
    box-shadow: 
      0 4px 10px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(255,255,255,0.9),
      inset 0 -1px 0 rgba(0,0,0,0.1),
      2px 3px 0 rgba(0,0,0,0.25);
    border: 1px solid rgba(0,0,0,0.12);
    transition: transform 0.15s, box-shadow 0.15s;
    cursor: default;
    position: relative;
    overflow: hidden;
    vertical-align: bottom;
  }

  .utile:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 8px 18px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.9), 2px 3px 0 rgba(0,0,0,0.2);
    z-index: 2;
  }

  .utile.winning {
    background: linear-gradient(160deg, #fff8e0 0%, #ffe8a0 100%);
    box-shadow: 
      0 4px 12px rgba(212,168,67,0.6),
      inset 0 1px 0 rgba(255,255,255,0.9),
      2px 3px 0 rgba(0,0,0,0.2);
    border-color: rgba(212,168,67,0.4);
  }

  .utile.winning::after {
    content: 'â˜…';
    position: absolute;
    top: 2px;
    right: 3px;
    font-size: 8px;
    color: var(--gold);
    z-index: 10;
  }

  .utile.flower-tile {
    background: linear-gradient(160deg, #fffbec 0%, #fdf0c8 100%);
    border-color: rgba(192,140,0,0.25);
  }

  .tile-gap {
    width: 16px;
    display: inline-block;
  }

  .hand-visual {
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 18px 20px 14px;
    margin: 12px 0;
    overflow-x: auto;
  }

  .hand-visual-label {
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    color: var(--gold);
    opacity: 0.7;
    margin-bottom: 10px;
    text-transform: uppercase;
  }

  /* RESPONSIVE */
  @media (max-width: 600px) {
    .tab-btn { font-size: 0.62rem; padding: 8px 8px; }
    .tile { width: 32px; height: 42px; font-size: 1.05rem; }
    .utile { width: 34px; height: 46px; font-size: 1.55rem; }
  }
</style>
</head>
<body>

<div class="hero">
  <p class="hero-eyebrow">Scoring Reference &amp; Tutorial</p>
  <h1>Hong Kong <span>Mahjong</span></h1>
  <p class="hero-sub">Master the fan system, payment rules, and hand values</p>
</div>

<div class="divider"><span class="divider-icon">ğŸ€„</span></div>

<div class="container">

  <div class="tab-nav">
    <button class="tab-btn active" onclick="showTab('basics')">The Basics</button>
    <button class="tab-btn" onclick="showTab('payments')">Payments</button>
    <button class="tab-btn" onclick="showTab('hands')">Hand Values</button>
    <button class="tab-btn" onclick="showTab('calculator')">Calculator</button>
    <button class="tab-btn" onclick="showTab('examples')">Examples</button>
    <button class="tab-btn" onclick="showTab('glossary')">Glossary</button>
  </div>

  <!-- BASICS -->
  <div class="tab-panel active" id="tab-basics">
    <p class="section-title">The Fan System</p>

    <div class="card">
      <p>Hong Kong Mahjong uses a <strong style="color:var(--gold-light)">fan-based scoring system</strong>. To score your winning hand, you count how many <em>fan</em> (ç•ª) it contains. Each fan roughly doubles the point value â€” up to 4 fan â€” then every <strong>2 additional fan</strong> doubles again.</p>
    </div>

    <div style="overflow-x:auto">
      <table class="fan-table" style="margin-bottom:24px">
        <thead>
          <tr>
            <th>Fan (ç•ª)</th>
            <th>Points</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="fan-num">0</td><td class="pts">1</td><td></td></tr>
          <tr><td class="fan-num">1</td><td class="pts">2</td><td></td></tr>
          <tr><td class="fan-num">2</td><td class="pts">4</td><td></td></tr>
          <tr><td class="fan-num">3</td><td class="pts">8</td><td></td></tr>
          <tr><td class="fan-num">4</td><td class="pts">16</td><td></td></tr>
          <tr><td class="fan-num">5</td><td class="pts">24</td><td>After 4 fan: every +2 fan doubles</td></tr>
          <tr><td class="fan-num">6</td><td class="pts">32</td><td></td></tr>
          <tr><td class="fan-num">7</td><td class="pts">48</td><td></td></tr>
          <tr><td class="fan-num">8</td><td class="pts">64</td><td></td></tr>
          <tr><td class="fan-num">9</td><td class="pts">96</td><td></td></tr>
          <tr><td class="fan-num">10</td><td class="pts">128</td><td>Common maximum</td></tr>
          <tr><td class="fan-num">11</td><td class="pts">192</td><td></td></tr>
          <tr><td class="fan-num">12</td><td class="pts">256</td><td></td></tr>
          <tr class="limit-row"><td class="fan-num">13+</td><td class="pts">384</td><td>Limit hand</td></tr>
        </tbody>
      </table>
    </div>

    <div class="tip">Most games require a minimum of 3 fan to declare Mahjong. Skip this requirement when playing with beginners.</div>

    <div class="tip" style="margin-top:10px">The maximum is often capped at 10 fan (128 points). Some house rules allow up to 13 fan (384 points).</div>
  </div>

  <!-- PAYMENTS -->
  <div class="tab-panel" id="tab-payments">
    <p class="section-title">Payment Rules â€” å…¨é“³åˆ¶</p>

    <div class="card">
      <p>This guide uses <strong style="color:var(--gold-light)">å…¨é“³åˆ¶ (discarder pays all)</strong> â€” the rule that the single player who discards your winning tile pays what all three opponents would have paid. This creates maximum pressure to discard carefully.</p>
    </div>

    <div class="payment-box">
      <h3>ğŸ€„ Self-Draw (è‡ªæ‘¸)</h3>
      <p>You drew the winning tile yourself from the wall. <strong style="color:var(--ivory)">All three opponents each pay your full hand value.</strong></p>
      <div class="hand-example" style="margin-top:14px">
        <div class="score-line"><span>Example: 4 fan hand = 16 points</span></div>
        <div class="score-line"><span>Each opponent pays</span><span class="pts-small">16 pts</span></div>
        <div class="score-total"><span>Your total gain</span><span>+48 pts</span></div>
      </div>
    </div>

    <div class="payment-box" style="border-color:rgba(212,168,67,0.3); background:rgba(212,168,67,0.06)">
      <h3 style="color:var(--gold)">ğŸ€„ Win by Discard (æ”¾éŠƒ)</h3>
      <p>An opponent discarded your winning tile. <strong style="color:var(--ivory)">Only that player pays â€” and they pay double your hand value.</strong> The other two players pay nothing.</p>
      <div class="hand-example" style="margin-top:14px">
        <div class="score-line"><span>Example: 7 fan hand = 48 points</span></div>
        <div class="score-line"><span>Discarder pays (2Ã—)</span><span class="pts-small">96 pts</span></div>
        <div class="score-line"><span>Other two players pay</span><span class="pts-small">0 pts</span></div>
        <div class="score-total"><span>Your total gain</span><span>+96 pts</span></div>
      </div>
    </div>

    <div class="tip">The discarder-pays-all system makes discarding riskier than self-draw wins â€” a single careless discard can be devastating for that player.</div>

    <div class="card" style="margin-top:20px">
      <div class="card-title">Alternative Rule (for reference)</div>
      <p>Some games use a different system: self-draw = 2Ã— from everyone; win by discard = 2Ã— from discarder + 1Ã— from each other player. The guide you're reading uses the discarder-pays-all version instead.</p>
    </div>
  </div>

  <!-- HAND VALUES -->
  <div class="tab-panel" id="tab-hands">
    <p class="section-title">All Hand Values</p>

    <!-- Flowers -->
    <p class="section-title" style="font-size:0.65rem; margin-top:4px">ğŸŒ¸ Flowers</p>
    <div class="card highlight">
      <div class="card-title"><span>No Flowers (æ— èŠ±)</span><span class="fan-badge">1 Fan</span></div>
      <p>You have no flower tiles at all. A small bonus for a pure hand.</p>
    </div>
    <div class="card highlight">
      <div class="card-title"><span>Seat Flower (æ­£èŠ±)</span><span class="fan-badge">1 Fan</span></div>
      <p>You hold the flower matching your seat wind: East=1, South=2, West=3, North=4. Each flower series has a season and a plant â€” south seat scores orchid or summer.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Set of Flowers (ä¸€å°èŠ±)</span><span class="fan-badge">2 Fan</span></div>
      <p>All 4 flowers of the same series (all four seasons, or all four plants).</p>
    </div>
    <div class="card">
      <div class="card-title"><span>7 Flowers (èŠ±ç³Š)</span><span class="fan-badge">3 Fan</span></div>
      <p>You drew 7 flowers â€” you may declare Mahjong immediately.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>8 Flowers (å…«ä»™éæµ·)</span><span class="fan-badge">8 Fan</span></div>
      <p>You drew all 8 flowers â€” instant Mahjong.</p>
    </div>

    <!-- Winning Methods -->
    <p class="section-title" style="margin-top:28px; font-size:0.65rem">ğŸ¯ Winning Methods</p>
    <div class="card highlight">
      <div class="card-title"><span>Self Draw (è‡ªæ‘¸)</span><span class="fan-badge">1 Fan</span></div>
      <p>You drew your winning tile yourself from the wall.</p>
    </div>
    <div class="card highlight">
      <div class="card-title"><span>Concealed Hand (é–€å‰æ¸…)</span><span class="fan-badge">1 Fan</span></div>
      <p>You won without ever calling chow, pong, or kong. Your entire hand stayed hidden.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Win on Final Tile (æµ·åº•æ’ˆæœˆ)</span><span class="fan-badge">1 Fan</span></div>
      <p>You drew the very last tile in the wall, or won on the last discard of the game.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>After a Kong (æ§“ä¸Šè‡ªæ‘¸)</span><span class="fan-badge">1 Fan</span></div>
      <p>You declared a kong, drew the replacement tile â€” and that tile completed your hand.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>After Multiple Kongs (æ§“ä¸Šæ§“)</span><span class="fan-badge">8 Fan</span></div>
      <p>You declared kong multiple times in a row and won on the replacement tile.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Robbing a Kong (æ¶æ§“)</span><span class="fan-badge">1 Fan</span></div>
      <p>An opponent added a tile to an open triplet to form a kong, and that tile completes your hand â€” you steal it.</p>
    </div>

    <!-- Suit Hands -->
    <p class="section-title" style="margin-top:28px; font-size:0.65rem">ğŸ´ Suit Hands</p>
    <div class="card highlight">
      <div class="card-title"><span>Mixed Flush (æ··ä¸€è‰²)</span><span class="fan-badge">3 Fan</span></div>
      <p>All tiles are from a single suit (bamboo, circles, or characters) plus honor tiles (winds/dragons).</p>
    </div>
    <div class="card highlight">
      <div class="card-title"><span>Pure Flush (æ¸…ä¸€è‰²)</span><span class="fan-badge">7 Fan</span></div>
      <p>All tiles are from a single suit â€” no honor tiles at all. A powerful and difficult hand.</p>
    </div>

    <!-- Honors -->
    <p class="section-title" style="margin-top:28px; font-size:0.65rem">ğŸ€„ Honor Tiles</p>
    <div class="card highlight">
      <div class="card-title"><span>Dragon Triplet (ç®­åˆ»)</span><span class="fan-badge">1 Fan each</span></div>
      <p>A triplet (pong) of any dragon tile â€” red, green, or white.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Round Wind (åœˆé¢¨åˆ»)</span><span class="fan-badge">1 Fan</span></div>
      <p>A triplet of the wind tile matching the current round (e.g., East triplet during East round).</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Seat Wind (é–€é¢¨åˆ»)</span><span class="fan-badge">1 Fan</span></div>
      <p>A triplet of the wind tile matching your own seat.</p>
    </div>
    <div class="card highlight">
      <div class="card-title"><span>Small Three Dragons (å°ä¸‰å…ƒ)</span><span class="fan-badge">5 Fan</span></div>
      <p>Two dragon triplets and a pair of the third dragon. Do not count individual dragon triplet fan â€” it's already included.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Big Three Dragons (å¤§ä¸‰å…ƒ)</span><span class="fan-badge">8 Fan</span></div>
      <p>Triplets of all three dragons. Again, do not add individual dragon fan.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Small Four Winds (å°å››å–œ)</span><span class="fan-badge">6 Fan</span></div>
      <p>Triplets of three winds and a pair of the fourth. Does not stack with mixed flush. Do not count individual wind fan.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Big Four Winds (å¤§å››å–œ)</span><span class="fan-badge limit">Limit</span></div>
      <p>Triplets of all four winds â€” an extremely rare and powerful hand. Pays the limit (384 pts).</p>
    </div>
    <div class="card">
      <div class="card-title"><span>All Honors (å­—ä¸€è‰²)</span><span class="fan-badge">10 Fan</span></div>
      <p>Your entire hand consists only of wind and dragon tiles.</p>
    </div>

    <!-- Triplets -->
    <p class="section-title" style="margin-top:28px; font-size:0.65rem">ğŸ€– Triplet Hands</p>
    <div class="card highlight">
      <div class="card-title"><span>All Triplets (ç¢°ç¢°ç³Š)</span><span class="fan-badge">3 Fan</span></div>
      <p>Every meld in your hand is a triplet (pong) or quad (kong). No sequences.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Four Concealed Triplets (ååèƒ¡)</span><span class="fan-badge">8 Fan</span></div>
      <p>All triplets, and all of them were drawn yourself (none called from discards).</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Mixed Terminals (æ··è€å¤´)</span><span class="fan-badge">4 Fan</span></div>
      <p>Hand contains only 1s, 9s, and honor tiles.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>All Terminals (æ¸…è€é ­)</span><span class="fan-badge limit">Limit</span></div>
      <p>Only 1s and 9s â€” no honor tiles, no sequences.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Four Kongs (åå…«ç¾…æ¼¢)</span><span class="fan-badge limit">Limit</span></div>
      <p>All four melds are kongs. Exceptionally rare.</p>
    </div>

    <!-- Sequences -->
    <p class="section-title" style="margin-top:28px; font-size:0.65rem">ğŸ”¢ Sequence Hands</p>
    <div class="card highlight">
      <div class="card-title"><span>All Sequences (å¹³ç³Š)</span><span class="fan-badge">1 Fan</span></div>
      <p>Every meld is a sequence (chow). Includes a pair. Simple but clean.</p>
    </div>

    <!-- Special -->
    <p class="section-title" style="margin-top:28px; font-size:0.65rem">âš¡ Special Hands</p>
    <div class="card">
      <div class="card-title"><span>Thirteen Orphans (åä¸‰å¹º)</span><span class="fan-badge limit">Limit</span></div>
      <p>One each of 1m, 9m, 1p, 9p, 1s, 9s, East, South, West, North, Red, Green, White â€” plus a pair of any one of them.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Nine Gates (ä¹å­é€£ç’°)</span><span class="fan-badge limit">Limit</span></div>
      <p>The concealed pattern 1-1-1-2-3-4-5-6-7-8-9-9-9 in one suit. Can win on any tile 1â€“9 of that suit.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Blessing of Heaven (å¤©ç³Š)</span><span class="fan-badge limit">Limit</span></div>
      <p>Win on the very first turn as the dealer.</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Blessing of Earth (åœ°ç³Š)</span><span class="fan-badge limit">Limit</span></div>
      <p>Win on the dealer's very first discard (as a non-dealer).</p>
    </div>
    <div class="card">
      <div class="card-title"><span>Blessing of Man (äººç³Š)</span><span class="fan-badge limit">Limit</span></div>
      <p>Win on the first turn as a non-dealer, before anyone else has discarded.</p>
    </div>

    <!-- Non-traditional -->
    <p class="section-title" style="margin-top:28px; font-size:0.65rem">âœ¦ Optional / Non-Traditional Hands</p>
    <div class="tip" style="margin-bottom:16px">These are not part of classic HK Mahjong. Include them by house rule agreement.</div>
    <div class="card"><div class="card-title"><span>Seven Pairs (ä¸ƒå°å­)</span><span class="fan-badge">3 Fan</span></div><p>Hand contains exactly 7 pairs instead of 4 melds + 1 pair.</p></div>
    <div class="card"><div class="card-title"><span>Three Kongs (ä¸‰æ§“å­)</span><span class="fan-badge">3 Fan</span></div><p>Three of your four melds are kongs.</p></div>
    <div class="card"><div class="card-title"><span>Pure Straight (ä¸€æ¢é¾)</span><span class="fan-badge">3 Fan</span></div><p>Have 1-2-3, 4-5-6, and 7-8-9 sequences all in the same suit.</p></div>
    <div class="card"><div class="card-title"><span>Mixed Triple Sequence (ä¸‰ç›¸é€¢)</span><span class="fan-badge">3 Fan</span></div><p>Same numbered sequence in all three suits (e.g., 5-6-7 in characters, dots, and bamboo).</p></div>
    <div class="card"><div class="card-title"><span>Two Identical Sequences (ä¸€èˆ¬é«˜)</span><span class="fan-badge">1 Fan</span></div><p>Two of the exact same sequence in the same suit (e.g., 1-2-3, 1-2-3 in dots).</p></div>
    <div class="card"><div class="card-title"><span>Three Identical Sequences (ä¸‰èˆ¬é«˜)</span><span class="fan-badge">3 Fan</span></div><p>Three of the same sequence in one suit.</p></div>
    <div class="card"><div class="card-title"><span>Four Identical Sequences (å››èˆ¬é«˜)</span><span class="fan-badge limit">Limit</span></div><p>Four copies of the same sequence in one suit â€” a near-impossible hand.</p></div>
  </div>

  <!-- CALCULATOR -->
  <div class="tab-panel" id="tab-calculator">
    <p class="section-title">Hand Calculator</p>

    <!-- PALETTE -->
    <div class="calc-section-label">â‘  Drag or tap tiles to build your hand</div>
    <div id="tilePalette" class="tile-palette">
      <div class="palette-row">
        <span class="suit-label char-label">Characters</span>
        <div class="palette-tiles" id="pal-char"></div>
      </div>
      <div class="palette-row">
        <span class="suit-label bam-label">Bamboo</span>
        <div class="palette-tiles" id="pal-bam"></div>
      </div>
      <div class="palette-row">
        <span class="suit-label dot-label">Circles</span>
        <div class="palette-tiles" id="pal-circle"></div>
      </div>
      <div class="palette-row">
        <span class="suit-label honor-label">Winds &amp; Dragons</span>
        <div class="palette-tiles" id="pal-honor"></div>
      </div>
      <div class="palette-row">
        <span class="suit-label flower-label">Flowers</span>
        <div class="palette-tiles" id="pal-flower"></div>
      </div>
    </div>

    <!-- HAND ZONE -->
    <div class="calc-section-label">â‘¡ Your hand <span id="handCount" class="hand-count-badge">0 tiles</span></div>
    <div id="handZone" class="hand-zone" ondragover="event.preventDefault()" ondrop="dropOnHand(event)">
      <div id="handTilesRow" class="hand-tiles-row"></div>
      <div id="handPlaceholder" class="hand-placeholder">Drop tiles here, or tap them above</div>
    </div>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button class="clear-btn" onclick="clearHand()">âœ• Clear Hand</button>
      <button class="clear-btn" style="background:rgba(212,168,67,0.12); border-color:rgba(212,168,67,0.3); color:var(--gold)" onclick="clearFlowers()">âœ• Clear Flowers</button>
    </div>

    <!-- SETTINGS -->
    <div class="calc-section-label" style="margin-top:20px">â‘¢ Settings</div>
    <div class="calc-settings-grid">
      <div class="setting-group">
        <span class="setting-label">Seat Wind</span>
        <div class="setting-pills">
          <button class="pill" id="sw-E" onclick="setSeat('E')">ğŸ€€ East</button>
          <button class="pill" id="sw-S" onclick="setSeat('S')">ğŸ€ South</button>
          <button class="pill" id="sw-W" onclick="setSeat('W')">ğŸ€‚ West</button>
          <button class="pill" id="sw-N" onclick="setSeat('N')">ğŸ€ƒ North</button>
        </div>
      </div>
      <div class="setting-group">
        <span class="setting-label">Round Wind</span>
        <div class="setting-pills">
          <button class="pill" id="rw-E" onclick="setRound('E')">ğŸ€€ East</button>
          <button class="pill" id="rw-S" onclick="setRound('S')">ğŸ€ South</button>
          <button class="pill" id="rw-W" onclick="setRound('W')">ğŸ€‚ West</button>
          <button class="pill" id="rw-N" onclick="setRound('N')">ğŸ€ƒ North</button>
        </div>
      </div>
      <div class="setting-group">
        <span class="setting-label">Win Method</span>
        <div class="setting-pills">
          <button class="pill selected" id="wm-discard" onclick="setWinMethod('discard')">ğŸ€„ Discard</button>
          <button class="pill" id="wm-self" onclick="setWinMethod('self')">ğŸ² Self Draw</button>
        </div>
      </div>
      <div class="setting-group">
        <span class="setting-label">Hand Type</span>
        <div class="setting-pills">
          <button class="pill selected" id="ht-open" onclick="setConcealed(false)">Open</button>
          <button class="pill" id="ht-conc" onclick="setConcealed(true)">Concealed</button>
        </div>
      </div>
    </div>

    <!-- RESULT -->
    <div id="calcOutput" class="calc-output">
      <div class="calc-output-placeholder">Add tiles to your hand to see your score</div>
    </div>
  </div>

  <!-- EXAMPLES -->
  <div class="tab-panel" id="tab-examples">
    <p class="section-title">Worked Examples</p>

    <!-- Example 1 -->
    <div class="card highlight">
      <div class="card-title">Example 1 â€” South Player, Won by Discard (from your game!)</div>
      <p style="font-size:0.93rem; color:var(--paper-dim); margin-bottom:14px">56 points â€¢ Won on the 6-character discarded by opponent</p>

      <div class="hand-visual">
        <div class="hand-visual-label">Exposed Melds</div>
        <div class="utile-row">

          <!-- Pong of 6-characters -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€Œ</div>
              <div class="utile">ğŸ€Œ</div>
              <div class="utile">ğŸ€Œ</div>
            </div>
            <div class="meld-label">Pong Â· 6-Char</div>
          </div>

          <!-- Chow 7-8-9 bamboo -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€–</div>
              <div class="utile">ğŸ€—</div>
              <div class="utile">ğŸ€˜</div>
            </div>
            <div class="meld-label">Chow Â· 7-8-9 Bam</div>
          </div>

          <!-- Pong of 1-circles -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€™</div>
              <div class="utile">ğŸ€™</div>
              <div class="utile">ğŸ€™</div>
            </div>
            <div class="meld-label">Pong Â· 1-Circle</div>
          </div>

          <!-- Kong of 8-characters -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€</div>
            </div>
            <div class="meld-label">Kong Â· 8-Char</div>
          </div>

          <div class="tile-gap"></div>

          <!-- Flowers -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile flower-tile">ğŸ€¢</div>
              <div class="utile flower-tile">ğŸ€¦</div>
            </div>
            <div class="meld-label">Flowers</div>
          </div>

          <div class="tile-gap"></div>

          <!-- Pair â€” winning tile highlighted -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€Œ</div>
              <div class="utile winning">ğŸ€Œ</div>
            </div>
            <div class="meld-label">Pair Â· Winning â˜…</div>
          </div>

        </div>

        <p style="font-size:0.8rem; color:rgba(245,230,200,0.5); margin-top:10px; font-style:italic">
          â˜… = the discarded winning tile (6-character)
        </p>
      </div>

      <div class="hand-score-breakdown" style="margin-bottom:16px">
        <div class="score-line"><span>All Triplets Â· ç¢°ç¢°ç³Š</span><span class="pts-small">3 fan</span></div>
        <div class="score-line"><span>Seat Flower (South = ğŸ€¦ orchid) Â· æ­£èŠ±</span><span class="pts-small">1 fan</span></div>
        <div class="score-line"><span>Kong of 8-characters (bonus draw earned)</span><span class="pts-small">+draw</span></div>
        <div class="score-total"><span>~4â€“5 fan total</span><span style="color:var(--gold-light)">56 pts</span></div>
      </div>

      <div class="payment-box" style="margin-top:0">
        <h3>ğŸ’¸ Payment â€” Discard Win (å…¨é“³åˆ¶)</h3>
        <div class="score-line"><span>Discarder pays 2 Ã— 56</span><span class="pts-small">112 pts</span></div>
        <div class="score-line"><span>Other 2 players pay</span><span class="pts-small">0 pts each</span></div>
        <div class="score-total"><span>Net gain</span><span>+224 pts âœ…</span></div>
      </div>
    </div>

    <!-- Example 2 -->
    <div class="card">
      <div class="card-title">Example 2 â€” Pure Flush + All Triplets, Self Draw ğŸ”¥</div>
      <p style="font-size:0.93rem; color:var(--paper-dim); margin-bottom:14px">192 points â€¢ All bamboo, all triplets, drew own winning tile</p>

      <div class="hand-visual">
        <div class="hand-visual-label">Full Hand</div>
        <div class="utile-row">

          <!-- Pong 1-bam -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€</div>
            </div>
            <div class="meld-label">Pong Â· 1-Bam</div>
          </div>

          <!-- Pong 3-bam -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€’</div>
              <div class="utile">ğŸ€’</div>
              <div class="utile">ğŸ€’</div>
            </div>
            <div class="meld-label">Pong Â· 3-Bam</div>
          </div>

          <!-- Pong 5-bam -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€”</div>
              <div class="utile">ğŸ€”</div>
              <div class="utile">ğŸ€”</div>
            </div>
            <div class="meld-label">Pong Â· 5-Bam</div>
          </div>

          <!-- Pong 7-bam -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€–</div>
              <div class="utile">ğŸ€–</div>
              <div class="utile">ğŸ€–</div>
            </div>
            <div class="meld-label">Pong Â· 7-Bam</div>
          </div>

          <div class="tile-gap"></div>

          <!-- Pair 9-bam -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€˜</div>
              <div class="utile winning">ğŸ€˜</div>
            </div>
            <div class="meld-label">Pair Â· Self Draw â˜…</div>
          </div>

        </div>
        <p style="font-size:0.8rem; color:rgba(245,230,200,0.5); margin-top:10px; font-style:italic">
          All 14 tiles are bamboo â€” this is a Pure Flush (æ¸…ä¸€è‰²)
        </p>
      </div>

      <div class="hand-score-breakdown" style="margin-bottom:16px">
        <div class="score-line"><span>Pure Flush Â· æ¸…ä¸€è‰²</span><span class="pts-small">7 fan</span></div>
        <div class="score-line"><span>All Triplets Â· ç¢°ç¢°ç³Š</span><span class="pts-small">3 fan</span></div>
        <div class="score-line"><span>Self Draw Â· è‡ªæ‘¸</span><span class="pts-small">1 fan</span></div>
        <div class="score-total"><span>11 fan total</span><span style="color:var(--gold-light)">192 pts</span></div>
      </div>

      <div class="payment-box" style="margin-top:0; border-color:rgba(212,168,67,0.35); background:rgba(212,168,67,0.07)">
        <h3 style="color:var(--gold)">ğŸ’¸ Payment â€” Self Draw</h3>
        <div class="score-line"><span>Each of 3 opponents pays</span><span class="pts-small">192 pts</span></div>
        <div class="score-total"><span>Total gain</span><span>+576 pts ğŸ”¥</span></div>
      </div>
    </div>

    <!-- Example 3 -->
    <div class="card">
      <div class="card-title">Example 3 â€” Mixed Flush, Minimum 3-Fan Win</div>
      <p style="font-size:0.93rem; color:var(--paper-dim); margin-bottom:14px">8 points base â€¢ Characters + East wind tiles, won by discard</p>

      <div class="hand-visual">
        <div class="hand-visual-label">Full Hand</div>
        <div class="utile-row">

          <!-- Chow 1-2-3 char -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€‡</div>
              <div class="utile">ğŸ€ˆ</div>
              <div class="utile">ğŸ€‰</div>
            </div>
            <div class="meld-label">Chow Â· 1-2-3 Char</div>
          </div>

          <!-- Chow 4-5-6 char -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€Š</div>
              <div class="utile">ğŸ€‹</div>
              <div class="utile">ğŸ€Œ</div>
            </div>
            <div class="meld-label">Chow Â· 4-5-6 Char</div>
          </div>

          <!-- Chow 7-8-9 char -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€</div>
            </div>
            <div class="meld-label">Chow Â· 7-8-9 Char</div>
          </div>

          <!-- Pong East wind -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€€</div>
              <div class="utile">ğŸ€€</div>
              <div class="utile">ğŸ€€</div>
            </div>
            <div class="meld-label">Pong Â· East Wind</div>
          </div>

          <div class="tile-gap"></div>

          <!-- Pair 3-char -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€‰</div>
              <div class="utile winning">ğŸ€‰</div>
            </div>
            <div class="meld-label">Pair Â· Winning â˜…</div>
          </div>

        </div>
        <p style="font-size:0.8rem; color:rgba(245,230,200,0.5); margin-top:10px; font-style:italic">
          Mix of characters + East wind tiles = Mixed Flush (æ··ä¸€è‰²)
        </p>
      </div>

      <div class="hand-score-breakdown" style="margin-bottom:16px">
        <div class="score-line"><span>Mixed Flush Â· æ··ä¸€è‰²</span><span class="pts-small">3 fan</span></div>
        <div class="score-line"><span>East Wind Triplet (round wind) Â· åœˆé¢¨åˆ»</span><span class="pts-small">1 fan</span></div>
        <div class="score-total"><span>4 fan total</span><span style="color:var(--gold-light)">16 pts</span></div>
      </div>

      <div class="payment-box" style="margin-top:0">
        <h3>ğŸ’¸ Payment â€” Discard Win (å…¨é“³åˆ¶)</h3>
        <div class="score-line"><span>Discarder pays 2 Ã— 16</span><span class="pts-small">32 pts</span></div>
        <div class="score-line"><span>Others pay</span><span class="pts-small">0 pts</span></div>
        <div class="score-total"><span>Net gain</span><span>+32 pts</span></div>
      </div>
    </div>

    <!-- Example 4 â€” Bonus: Special Hand -->
    <div class="card">
      <div class="card-title">Example 4 â€” Small Three Dragons (å°ä¸‰å…ƒ)</div>
      <p style="font-size:0.93rem; color:var(--paper-dim); margin-bottom:14px">5 fan base â€¢ Two dragon pongs + a dragon pair</p>

      <div class="hand-visual">
        <div class="hand-visual-label">Full Hand</div>
        <div class="utile-row">

          <!-- Chow in circles -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€›</div>
              <div class="utile">ğŸ€œ</div>
              <div class="utile">ğŸ€</div>
            </div>
            <div class="meld-label">Chow Â· 3-4-5 Dot</div>
          </div>

          <!-- Another sequence -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€</div>
              <div class="utile">ğŸ€Ÿ</div>
              <div class="utile">ğŸ€ </div>
            </div>
            <div class="meld-label">Chow Â· 6-7-8 Dot</div>
          </div>

          <!-- Pong Red Dragon -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€„</div>
              <div class="utile">ğŸ€„</div>
              <div class="utile">ğŸ€„</div>
            </div>
            <div class="meld-label">Pong Â· Red Dragon</div>
          </div>

          <!-- Pong Green Dragon -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€…</div>
              <div class="utile">ğŸ€…</div>
              <div class="utile">ğŸ€…</div>
            </div>
            <div class="meld-label">Pong Â· Green Dragon</div>
          </div>

          <div class="tile-gap"></div>

          <!-- Pair White Dragon -->
          <div class="meld-col">
            <div class="meld-wrap">
              <div class="utile">ğŸ€†</div>
              <div class="utile winning">ğŸ€†</div>
            </div>
            <div class="meld-label">Pair Â· White Dragon â˜…</div>
          </div>

        </div>
        <p style="font-size:0.8rem; color:rgba(245,230,200,0.5); margin-top:10px; font-style:italic">
          2 dragon pongs + 1 dragon pair = Small Three Dragons. Do NOT add individual dragon pong fan separately.
        </p>
      </div>

      <div class="hand-score-breakdown" style="margin-bottom:16px">
        <div class="score-line"><span>Small Three Dragons Â· å°ä¸‰å…ƒ</span><span class="pts-small">5 fan</span></div>
        <div class="score-line"><span>Self Draw Â· è‡ªæ‘¸</span><span class="pts-small">1 fan</span></div>
        <div class="score-total"><span>6 fan total</span><span style="color:var(--gold-light)">32 pts</span></div>
      </div>

      <div class="payment-box" style="margin-top:0; border-color:rgba(212,168,67,0.35); background:rgba(212,168,67,0.07)">
        <h3 style="color:var(--gold)">ğŸ’¸ Payment â€” Self Draw</h3>
        <div class="score-line"><span>Each of 3 opponents pays</span><span class="pts-small">32 pts</span></div>
        <div class="score-total"><span>Total gain</span><span>+96 pts</span></div>
      </div>
    </div>

  </div>

  <!-- GLOSSARY -->
  <div class="tab-panel" id="tab-glossary">
    <p class="section-title">Key Terms</p>
    <div class="gloss-grid">
      <div class="gloss-card"><p class="gloss-term">Fan / ç•ª</p><p class="gloss-desc">Scoring units. Each fan doubles your base points (up to 4 fan, then every 2 fan doubles).</p></div>
      <div class="gloss-card"><p class="gloss-term">Chow / é †å­</p><p class="gloss-desc">A sequence of 3 consecutive tiles in the same suit (e.g., 3-4-5 of bamboo).</p></div>
      <div class="gloss-card"><p class="gloss-term">Pong / ç¢°</p><p class="gloss-desc">A triplet â€” three identical tiles.</p></div>
      <div class="gloss-card"><p class="gloss-term">Kong / æ§“</p><p class="gloss-desc">A quad â€” four identical tiles. Earns a bonus replacement tile draw.</p></div>
      <div class="gloss-card"><p class="gloss-term">Zimo / è‡ªæ‘¸</p><p class="gloss-desc">Self-draw win. You pull the winning tile from the wall yourself.</p></div>
      <div class="gloss-card"><p class="gloss-term">Discard / æ”¾éŠƒ</p><p class="gloss-desc">Another player discards your winning tile. Under å…¨é“³åˆ¶, they pay double alone.</p></div>
      <div class="gloss-card"><p class="gloss-term">Concealed Hand / é–€å‰æ¸…</p><p class="gloss-desc">Winning without having called any melds. All tiles stay hidden until win.</p></div>
      <div class="gloss-card"><p class="gloss-term">Limit Hand</p><p class="gloss-desc">A special hand worth 13+ fan â€” pays the maximum (commonly 384 pts). Rare and powerful.</p></div>
      <div class="gloss-card"><p class="gloss-term">Seat Wind</p><p class="gloss-desc">Your position: East (1), South (2), West (3), North (4). Affects flower scoring and wind triplet value.</p></div>
      <div class="gloss-card"><p class="gloss-term">Round Wind</p><p class="gloss-desc">The current round's wind (usually East or South). Wind triplets matching it score 1 fan.</p></div>
      <div class="gloss-card"><p class="gloss-term">Honor Tiles</p><p class="gloss-desc">Wind tiles (East, South, West, North) and Dragon tiles (Red, Green, White). Not part of any numbered suit.</p></div>
      <div class="gloss-card"><p class="gloss-term">Tenpai</p><p class="gloss-desc">One tile away from winning. You're waiting on a specific tile to complete your hand.</p></div>
    </div>
  </div>

</div><!-- /container -->

<script>
  // ===================== TILE RENDERING =====================
  function bamPips(n) {
    // columns of pips per number
    const cols = [[1],[1,1],[1,1,1],[2,2],[2,3],[3,3],[3,4],[4,4],[3,3,3]][n-1];
    const colCount = cols.length;
    const maxPips  = Math.max(...cols);
    const pH = maxPips <= 2 ? 13 : maxPips <= 3 ? 10 : 8;
    const pW = colCount <= 1 ? 13 : colCount <= 2 ? 11 : 8;
    const gap = colCount <= 2 ? 3 : 2;
    return `<div style="display:flex;gap:${gap}px;align-items:center;justify-content:center;width:100%;flex:1;padding:0 2px">`+
      cols.map(c =>
        `<div style="display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center">`+
        Array(c).fill(0).map(() =>
          `<div style="width:${pW}px;height:${pH}px;background:linear-gradient(180deg,#5dcc5d 0%,#1a8a1a 100%);border-radius:${Math.ceil(pW/2)}px;border:1px solid rgba(0,60,0,0.25);box-shadow:inset 1px 0 2px rgba(255,255,255,0.4),0 1px 2px rgba(0,0,0,0.2)"></div>`
        ).join('')+`</div>`
      ).join('')+`</div>`;
  }

  function circlePips(n) {
    const cols = [[1],[1,1],[1,1,1],[2,2],[2,3],[3,3],[3,4],[4,4],[3,3,3]][n-1];
    const maxPips = Math.max(...cols);
    const r = maxPips <= 2 ? 8 : maxPips <= 3 ? 7 : 5;
    const gap = cols.length <= 2 ? 3 : 2;
    return `<div style="display:flex;gap:${gap}px;align-items:center;justify-content:center;width:100%;flex:1;padding:0 2px">`+
      cols.map(c =>
        `<div style="display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center">`+
        Array(c).fill(0).map(() =>
          `<div style="width:${r*2}px;height:${r*2}px;border-radius:50%;background:radial-gradient(circle at 35% 30%,#7a9eff,#1030c0);border:1px solid rgba(5,15,80,0.35);box-shadow:inset 1px 1px 3px rgba(255,255,255,0.45),0 1px 2px rgba(0,0,0,0.3)"></div>`
        ).join('')+`</div>`
      ).join('')+`</div>`;
  }

  function tileInnerHTML(suit, val) {
    // All content fills tile via position:absolute inset:0
    const wrap = (content, extraStyle='') =>
      `<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;${extraStyle}">${content}</div>`;

    const gloss = `<div style="position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.18) 0%,transparent 55%);pointer-events:none;border-radius:inherit;z-index:5"></div>`;

    if (suit === 'char') {
      const CN = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
      return wrap(`<span style="font-size:21px;color:#cc1818;font-family:'Noto Serif SC',serif;font-weight:700;line-height:1;text-shadow:0 1px 2px rgba(0,0,0,0.1)">${CN[val-1]}</span><span style="font-size:9px;color:#cc1818;font-family:'Noto Serif SC',serif;margin-top:1px;line-height:1;opacity:0.9">ä¸‡</span>`) + gloss;
    }

    if (suit === 'bam') {
      return wrap(
        bamPips(val) +
        `<span style="font-size:8px;color:#1a7a1a;font-family:'Cinzel',serif;line-height:1;margin-top:2px;font-weight:600">${val}</span>`,
        'justify-content:flex-start;padding-top:5px;gap:0'
      ) + gloss;
    }

    if (suit === 'circle') {
      return wrap(
        circlePips(val) +
        `<span style="font-size:8px;color:#1030b0;font-family:'Cinzel',serif;line-height:1;margin-top:2px;font-weight:600">${val}</span>`,
        'justify-content:flex-start;padding-top:5px;gap:0'
      ) + gloss;
    }

    if (suit === 'wind') {
      const chars  = ['æ±','å—','è¥¿','åŒ—'];
      const colors = ['#9010c0','#c03010','#1050b0','#107050'];
      return wrap(
        `<span style="font-size:21px;color:${colors[val-1]};font-family:'Noto Serif SC',serif;font-weight:700;line-height:1;text-shadow:0 1px 2px rgba(0,0,0,0.1)">${chars[val-1]}</span>`+
        `<span style="font-size:9px;color:${colors[val-1]};font-family:'Noto Serif SC',serif;margin-top:1px;line-height:1;opacity:0.8">é¢¨</span>`
      ) + gloss;
    }

    if (suit === 'dragon') {
      if (val === 1) return ( // Red dragon ä¸­
        `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">` +
        `<div style="width:34px;height:40px;background:linear-gradient(160deg,#e82020 0%,#a01010 100%);border-radius:5px;display:flex;align-items:center;justify-content:center;box-shadow:inset 0 1px 0 rgba(255,255,255,0.3),0 2px 5px rgba(0,0,0,0.35)">` +
        `<span style="font-size:22px;color:#fff;font-family:'Noto Serif SC',serif;font-weight:700;line-height:1;text-shadow:0 1px 3px rgba(0,0,0,0.4)">ä¸­</span></div></div>` + gloss);
      if (val === 2) return ( // Green dragon ç™¼
        `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">` +
        `<div style="width:34px;height:40px;background:linear-gradient(160deg,#22b822 0%,#107010 100%);border-radius:5px;display:flex;align-items:center;justify-content:center;box-shadow:inset 0 1px 0 rgba(255,255,255,0.3),0 2px 5px rgba(0,0,0,0.35)">` +
        `<span style="font-size:22px;color:#fff;font-family:'Noto Serif SC',serif;font-weight:700;line-height:1;text-shadow:0 1px 3px rgba(0,0,0,0.4)">ç™¼</span></div></div>` + gloss);
      return ( // White dragon ç™½
        `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">` +
        `<div style="width:34px;height:40px;border:2.5px solid #a0a0a0;border-radius:5px;display:flex;align-items:center;justify-content:center;background:rgba(245,245,245,0.6)">` +
        `<span style="font-size:14px;color:#707070;font-family:'Noto Serif SC',serif;font-weight:600;line-height:1">ç™½</span></div></div>` + gloss);
    }

    if (suit === 'flower') {
      const chars  = ['æ˜¥','å¤','ç§‹','å†¬','æ¢…','è˜­','èŠ','ç«¹'];
      const series = val <= 4 ? 'å­£' : 'èŠ±';
      const col    = val <= 4 ? '#b06010' : '#900080';
      return wrap(
        `<span style="font-size:20px;color:${col};font-family:'Noto Serif SC',serif;font-weight:700;line-height:1;text-shadow:0 1px 2px rgba(0,0,0,0.1)">${chars[val-1]}</span>`+
        `<span style="font-size:9px;color:${col};font-family:'Noto Serif SC',serif;margin-top:1px;line-height:1;opacity:0.85">${series}</span>`
      ) + gloss;
    }
    return '';
  }

  // Reverse emoji â†’ {suit,val} map for re-rendering hardcoded .utile divs in examples
  const EMOJI_MAP = {};
  (function(){
    const SE={char:['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'],bam:['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜'],circle:['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'],wind:['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ'],dragon:['ğŸ€„','ğŸ€…','ğŸ€†'],flower:['ğŸ€¢','ğŸ€£','ğŸ€¤','ğŸ€¥','ğŸ€¦','ğŸ€§','ğŸ€¨','ğŸ€©']};
    Object.entries(SE).forEach(([suit,emojis])=>emojis.forEach((e,i)=>EMOJI_MAP[e]={suit,val:i+1}));
  })();

  // ===================== TAB SWITCHING =====================
  function showTab(id) {
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    event.target.classList.add('active');
  }

  // ===================== TILE DEFINITIONS =====================
  const SUIT_EMOJIS={char:['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'],bam:['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜'],circle:['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'],wind:['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ'],dragon:['ğŸ€„','ğŸ€…','ğŸ€†'],flower:['ğŸ€¢','ğŸ€£','ğŸ€¤','ğŸ€¥','ğŸ€¦','ğŸ€§','ğŸ€¨','ğŸ€©']};

  function makeTile(suit,val){const idx=val-1;return{suit,value:val,emoji:SUIT_EMOJIS[suit][idx]};}
  function tileKey(t){return t.suit+'-'+t.value;}
  function sameTile(a,b){return a.suit===b.suit&&a.value===b.value;}
  const SUIT_ORDER={char:0,bam:1,circle:2,wind:3,dragon:4,flower:5};
  function cmpTiles(a,b){if(a.suit!==b.suit)return SUIT_ORDER[a.suit]-SUIT_ORDER[b.suit];return a.value-b.value;}

  // ===================== HAND STATE =====================
  let hand=[], flowers=[];
  let settings={seatWind:'E',roundWind:'E',winMethod:'discard',concealed:false};

  // ===================== BUILD PALETTE =====================
  function buildPalette() {
    ['char','bam','circle'].forEach(id=>{
      const el=document.getElementById('pal-'+id);
      for(let v=1;v<=9;v++) el.appendChild(makePaletteDiv(makeTile(id,v)));
    });
    const honorEl=document.getElementById('pal-honor');
    [1,2,3,4].forEach(v=>honorEl.appendChild(makePaletteDiv(makeTile('wind',v))));
    honorEl.appendChild(Object.assign(document.createElement('span'),{style:'display:inline-block;width:10px'}));
    [1,2,3].forEach(v=>honorEl.appendChild(makePaletteDiv(makeTile('dragon',v))));
    const flowerEl=document.getElementById('pal-flower');
    for(let v=1;v<=8;v++) flowerEl.appendChild(makePaletteDiv(makeTile('flower',v)));
  }

  function makePaletteDiv(tile) {
    const div=document.createElement('div');
    div.className='p-tile';
    div.innerHTML=tileInnerHTML(tile.suit,tile.value);
    div.draggable=true;
    div.dataset.suit=tile.suit;
    div.dataset.val=tile.value;
    div.title=getTileName(tile);
    div.addEventListener('dragstart',e=>{e.dataTransfer.setData('suit',tile.suit);e.dataTransfer.setData('val',tile.value);div.classList.add('dragging');});
    div.addEventListener('dragend',()=>div.classList.remove('dragging'));
    div.addEventListener('click',()=>addTile(tile.suit,tile.value));
    // Touch
    let ghost=null;
    div.addEventListener('touchstart',e=>{
      const touch=e.touches[0];
      ghost=document.createElement('div');
      ghost.className='p-tile';
      ghost.innerHTML=tileInnerHTML(tile.suit,tile.value);
      ghost.style.cssText=`position:fixed;opacity:0.9;pointer-events:none;z-index:9999;left:${touch.clientX-20}px;top:${touch.clientY-26}px;transition:none;width:40px;height:52px;`;
      document.body.appendChild(ghost);
    },{passive:true});
    div.addEventListener('touchmove',e=>{
      if(!ghost)return;
      const touch=e.touches[0];
      ghost.style.left=(touch.clientX-20)+'px';ghost.style.top=(touch.clientY-26)+'px';
      const z=document.getElementById('handZone'),r=z.getBoundingClientRect();
      z.classList.toggle('drag-over',touch.clientX>=r.left&&touch.clientX<=r.right&&touch.clientY>=r.top&&touch.clientY<=r.bottom);
    },{passive:true});
    div.addEventListener('touchend',e=>{
      if(ghost){ghost.remove();ghost=null;}
      document.getElementById('handZone').classList.remove('drag-over');
      const touch=e.changedTouches[0],z=document.getElementById('handZone'),r=z.getBoundingClientRect();
      if(touch.clientX>=r.left&&touch.clientX<=r.right&&touch.clientY>=r.top&&touch.clientY<=r.bottom) addTile(tile.suit,tile.value);
    },{passive:true});
    return div;
  }

  // ===================== ADD / REMOVE TILES =====================
  function addTile(suit,val){
    const tile=makeTile(suit,parseInt(val));
    if(suit==='flower'){flowers.push(tile);}
    else{if(hand.length>=14){showFlash('Hand is full (14 tiles max)');return;}hand.push(tile);}
    renderHand();recalculate();
  }
  function removeTile(isFlower,idx){if(isFlower)flowers.splice(idx,1);else hand.splice(idx,1);renderHand();recalculate();}
  function clearHand(){hand=[];renderHand();recalculate();}
  function clearFlowers(){flowers=[];renderHand();recalculate();}
  function dropOnHand(e){e.preventDefault();document.getElementById('handZone').classList.remove('drag-over');const suit=e.dataTransfer.getData('suit'),val=e.dataTransfer.getData('val');if(suit&&val)addTile(suit,val);}

  document.addEventListener('DOMContentLoaded',()=>{
    const hz=document.getElementById('handZone');
    hz.addEventListener('dragover',e=>{e.preventDefault();hz.classList.add('drag-over');});
    hz.addEventListener('dragleave',()=>hz.classList.remove('drag-over'));
    // Re-render all .utile divs in examples with colored tiles
    document.querySelectorAll('.utile').forEach(el=>{
      const emoji=el.textContent.trim();
      const t=EMOJI_MAP[emoji];
      if(t) el.innerHTML=tileInnerHTML(t.suit,t.val);
    });
  });

  // ===================== RENDER HAND =====================
  function renderHand(){
    const row=document.getElementById('handTilesRow'),ph=document.getElementById('handPlaceholder');
    row.innerHTML='';
    const sorted=[...hand].sort(cmpTiles);
    let handIdx=0;
    sorted.forEach(t=>{
      const origIdx=hand.findIndex((h,hi)=>tileKey(h)===tileKey(t)&&hand.slice(0,hi).filter(x=>tileKey(x)===tileKey(t)).length===sorted.slice(0,handIdx).filter(x=>tileKey(x)===tileKey(t)).length);
      handIdx++;
      const div=document.createElement('div');
      div.className='h-tile';
      div.innerHTML=tileInnerHTML(t.suit,t.value);
      div.title='Click to remove: '+getTileName(t);
      const fi=hand.findIndex(h=>tileKey(h)===tileKey(t));
      div.onclick=()=>removeTile(false,fi);
      row.appendChild(div);
    });
    if(flowers.length>0&&hand.length>0){const sep=document.createElement('div');sep.className='hand-divider';row.appendChild(sep);}
    flowers.forEach((t,i)=>{
      const div=document.createElement('div');
      div.className='h-tile flower'+(i===0?' flower-sep':'');
      div.innerHTML=tileInnerHTML(t.suit,t.value);
      div.title='Click to remove: '+getTileName(t);
      div.onclick=()=>removeTile(true,i);
      row.appendChild(div);
    });
    const total=hand.length+flowers.length;
    ph.style.display=total===0?'block':'none';
    document.getElementById('handCount').textContent=hand.length+' tile'+(hand.length!==1?'s':'')+(flowers.length>0?' + '+flowers.length+' flower'+(flowers.length>1?'s':''):'');
  }

  // ===================== SETTINGS =====================
  function setSeat(w){settings.seatWind=w;['E','S','W','N'].forEach(x=>document.getElementById('sw-'+x).classList.toggle('selected',x===w));recalculate();}
  function setRound(w){settings.roundWind=w;['E','S','W','N'].forEach(x=>document.getElementById('rw-'+x).classList.toggle('selected',x===w));recalculate();}
  function setWinMethod(m){settings.winMethod=m;document.getElementById('wm-discard').classList.toggle('selected',m==='discard');document.getElementById('wm-self').classList.toggle('selected',m==='self');recalculate();}
  function setConcealed(c){settings.concealed=c;document.getElementById('ht-open').classList.toggle('selected',!c);document.getElementById('ht-conc').classList.toggle('selected',c);recalculate();}

  // ===================== HAND SOLVER =====================
  function solveHand(tiles){const sorted=[...tiles].sort(cmpTiles);return solveRec(sorted,false,[]);}
  function solveRec(tiles,pairUsed,melds){
    if(tiles.length===0)return pairUsed?melds:null;
    const first=tiles[0],rest=tiles.slice(1);
    if(rest.length>=3&&sameTile(rest[0],first)&&sameTile(rest[1],first)&&sameTile(rest[2],first)){const r=solveRec(rest.slice(3),pairUsed,[...melds,{type:'kong',tile:first}]);if(r)return r;}
    if(rest.length>=2&&sameTile(rest[0],first)&&sameTile(rest[1],first)){const r=solveRec(rest.slice(2),pairUsed,[...melds,{type:'pong',tile:first}]);if(r)return r;}
    if(['char','bam','circle'].includes(first.suit)&&first.value<=7){const i2=rest.findIndex(t=>t.suit===first.suit&&t.value===first.value+1);if(i2!==-1){const rest2=rest.filter((_,i)=>i!==i2);const i3=rest2.findIndex(t=>t.suit===first.suit&&t.value===first.value+2);if(i3!==-1){const rest3=rest2.filter((_,i)=>i!==i3);const r=solveRec(rest3,pairUsed,[...melds,{type:'chow',suit:first.suit,start:first.value,tile:first}]);if(r)return r;}}}
    if(!pairUsed&&rest.length>=1&&sameTile(rest[0],first)){const r=solveRec(rest.slice(1),true,[...melds,{type:'pair',tile:first}]);if(r)return r;}
    return null;
  }
  function check7Pairs(tiles){if(tiles.length!==14)return false;const c={};for(const t of tiles)c[tileKey(t)]=(c[tileKey(t)]||0)+1;const vals=Object.values(c);return vals.length===7&&vals.every(v=>v===2);}

  // ===================== FAN CALCULATION =====================
  const FAN_PTS={0:1,1:2,2:4,3:8,4:16,5:24,6:32,7:48,8:64,9:96,10:128,11:192,12:256};
  function fanToPoints(f){if(f>=13)return 384;return FAN_PTS[f]||384;}
  const LIMIT=99;

  function calcFan(hand,flowers,settings){
    const fanList=[];
    if(flowers.length===8){fanList.push({name:'Eight Flowers å…«ä»™éæµ·',val:LIMIT});}
    else if(flowers.length===7){fanList.push({name:'Seven Flowers èŠ±ç³Š',val:3});}
    else{
      if(flowers.length===0&&hand.length>0)fanList.push({name:'No Flowers æ— èŠ±',val:1});
      const sn={E:1,S:2,W:3,N:4}[settings.seatWind]||0;
      if(sn&&flowers.some(f=>f.value===sn||f.value===sn+4))fanList.push({name:'Seat Flower æ­£èŠ±',val:1});
      const seasons=flowers.filter(f=>f.value<=4),plants=flowers.filter(f=>f.value>=5);
      if(seasons.length===4)fanList.push({name:'Set of Flowers (Seasons)',val:2});
      if(plants.length===4)fanList.push({name:'Set of Flowers (Plants)',val:2});
    }
    if(fanList.some(f=>f.val===LIMIT))return{fanList,valid:true,limitHand:true};
    if(settings.winMethod==='self')fanList.push({name:'Self Draw è‡ªæ‘¸',val:1});
    else if(settings.concealed)fanList.push({name:'Concealed Hand é–€å‰æ¸…',val:1});
    if(hand.length<13)return{fanList,valid:false};
    const is7p=check7Pairs(hand),solved=solveHand(hand),valid=is7p||!!solved;
    if(!valid)return{fanList,valid:false};
    if(is7p)fanList.push({name:'Seven Pairs ä¸ƒå°å­',val:3});
    if(solved){
      const pair=solved.find(m=>m.type==='pair'),nonPair=solved.filter(m=>m.type!=='pair');
      const allPongs=nonPair.every(m=>m.type==='pong'||m.type==='kong'),allChows=nonPair.every(m=>m.type==='chow'),kongs=nonPair.filter(m=>m.type==='kong');
      if(allPongs&&settings.concealed)fanList.push({name:'Four Concealed Triplets ååèƒ¡',val:8});
      else if(allPongs)fanList.push({name:'All Triplets ç¢°ç¢°ç³Š',val:3});
      if(allChows)fanList.push({name:'All Sequences å¹³ç³Š',val:1});
      if(kongs.length===4)fanList.push({name:'Four Kongs åå…«ç¾…æ¼¢',val:LIMIT});
      else if(kongs.length===3)fanList.push({name:'Three Kongs ä¸‰æ§“å­',val:3});
      const suits=new Set(hand.map(t=>t.suit)),hasHonor=suits.has('wind')||suits.has('dragon'),numSuits=[...suits].filter(s=>['char','bam','circle'].includes(s));
      if(numSuits.length===1&&!hasHonor)fanList.push({name:'Pure Flush æ¸…ä¸€è‰²',val:7});
      else if(numSuits.length===1&&hasHonor)fanList.push({name:'Mixed Flush æ··ä¸€è‰²',val:3});
      if([...suits].every(s=>s==='wind'||s==='dragon'))fanList.push({name:'All Honors å­—ä¸€è‰²',val:10});
      const allTermHon=hand.every(t=>t.suit==='wind'||t.suit==='dragon'||t.value===1||t.value===9);
      const allTerm=hand.every(t=>['char','bam','circle'].includes(t.suit)&&(t.value===1||t.value===9));
      if(allTerm)fanList.push({name:'All Terminals æ¸…è€é ­',val:LIMIT});
      else if(allTermHon)fanList.push({name:'Mixed Terminals æ··è€å¤´',val:4});
      const dPongs=nonPair.filter(m=>(m.type==='pong'||m.type==='kong')&&m.tile.suit==='dragon'),dPair=pair&&pair.tile.suit==='dragon';
      if(dPongs.length===3)fanList.push({name:'Big Three Dragons å¤§ä¸‰å…ƒ',val:8});
      else if(dPongs.length===2&&dPair)fanList.push({name:'Small Three Dragons å°ä¸‰å…ƒ',val:5});
      else dPongs.forEach(p=>fanList.push({name:'Dragon Triplet '+['ä¸­','ç™¼','ç™½'][p.tile.value-1]+' ç®­åˆ»',val:1}));
      const wPongs=nonPair.filter(m=>(m.type==='pong'||m.type==='kong')&&m.tile.suit==='wind'),wPair=pair&&pair.tile.suit==='wind';
      if(wPongs.length===4)fanList.push({name:'Big Four Winds å¤§å››å–œ',val:LIMIT});
      else if(wPongs.length===3&&wPair)fanList.push({name:'Small Four Winds å°å››å–œ',val:6});
      else{const wn=['East','South','West','North'],rw={E:1,S:2,W:3,N:4}[settings.roundWind]||0,sw={E:1,S:2,W:3,N:4}[settings.seatWind]||0;wPongs.forEach(p=>{if(p.tile.value===rw)fanList.push({name:'Round Wind Triplet åœˆé¢¨åˆ» ('+wn[rw-1]+')',val:1});if(p.tile.value===sw)fanList.push({name:'Seat Wind Triplet é–€é¢¨åˆ» ('+wn[sw-1]+')',val:1});});}
      const chows=nonPair.filter(m=>m.type==='chow');
      ['char','bam','circle'].forEach(s=>{if([1,4,7].every(v=>chows.some(c=>c.suit===s&&c.start===v)))fanList.push({name:'Pure Straight ä¸€æ¢é¾ ('+s+')',val:3});});
      const cbs={};chows.forEach(c=>{cbs[c.start]=cbs[c.start]||new Set();cbs[c.start].add(c.suit);});Object.entries(cbs).forEach(([v,ss])=>{if(ss.size===3)fanList.push({name:'Mixed Triple Sequence ä¸‰ç›¸é€¢ ('+v+'-'+(+v+1)+'-'+(+v+2)+')',val:3});});
      const ck={};chows.forEach(c=>{const k=c.suit+c.start;ck[k]=(ck[k]||0)+1;});const mx=Math.max(0,...Object.values(ck));
      if(mx>=4)fanList.push({name:'Four Identical Sequences å››èˆ¬é«˜',val:LIMIT});
      else if(mx===3)fanList.push({name:'Three Identical Sequences ä¸‰èˆ¬é«˜',val:3});
      else if(mx===2)fanList.push({name:'Two Identical Sequences ä¸€èˆ¬é«˜',val:1});
    }
    return{fanList,valid:true,limitHand:fanList.some(f=>f.val===LIMIT)};
  }

  // ===================== DISPLAY RESULT =====================
  function recalculate(){
    const out=document.getElementById('calcOutput');
    if(hand.length===0&&flowers.length===0){out.innerHTML='<div class="calc-output-placeholder">Add tiles to your hand to see your score</div>';return;}
    const{fanList,valid,limitHand}=calcFan(hand,flowers,settings);
    let html='';
    if(fanList.length>0){html+='<div class="fan-breakdown">';fanList.forEach(f=>{const label=f.val===LIMIT?'<span class="fan-row-val limit">LIMIT</span>':`<span class="fan-row-val">+${f.val} fan</span>`;html+=`<div class="fan-row"><span>${f.name}</span>${label}</div>`;});html+='</div>';}
    if(hand.length>0&&hand.length<13){html+=`<div class="calc-invalid">Add ${13-hand.length} more tile${13-hand.length>1?'s':''} to evaluate your hand</div>`;}
    else if(hand.length>=13&&!valid){html+='<div class="calc-invalid">Hand is not yet a valid winning hand. Keep building!</div>';}
    else if(valid||limitHand){
      const rf=fanList.filter(f=>f.val!==LIMIT).reduce((s,f)=>s+f.val,0),pts=limitHand?384:fanToPoints(rf),fl=limitHand?'LIMIT (13+)':rf+' fan';
      html+=`<div class="score-summary"><div class="score-big">${pts} pts <span style="font-size:0.9rem;color:var(--paper-dim);font-family:'Cormorant Garamond',serif;font-style:italic">(${fl})</span></div>`;
      if(settings.winMethod==='self'){html+=`<div class="score-sub">Self-draw: all 3 opponents each pay ${pts} pts</div><div class="score-payment"><div class="score-payment-line"><span>Each of 3 opponents pays</span><strong>${pts} pts</strong></div><div class="score-payment-line" style="margin-top:6px;border-top:1px solid rgba(212,168,67,0.2);padding-top:6px"><span>Your total gain</span><strong style="color:#72e890">+${pts*3} pts</strong></div></div>`;}
      else{html+=`<div class="score-sub">Discard win: discarder pays ${pts*2} pts, others pay nothing</div><div class="score-payment"><div class="score-payment-line"><span>Discarder pays (2Ã— hand value)</span><strong>${pts*2} pts</strong></div><div class="score-payment-line"><span>Other 2 players pay</span><strong>0 pts</strong></div><div class="score-payment-line" style="margin-top:6px;border-top:1px solid rgba(212,168,67,0.2);padding-top:6px"><span>Your total gain</span><strong style="color:#72e890">+${pts*2} pts</strong></div></div>`;}
      html+=`</div>`;
    }
    out.innerHTML=html||'<div class="calc-output-placeholder">Keep adding tilesâ€¦</div>';
  }

  // ===================== TILE NAMES =====================
  function getTileName(t){
    if(t.suit==='char')return t.value+'-Character';
    if(t.suit==='bam')return t.value+'-Bamboo';
    if(t.suit==='circle')return t.value+'-Circle';
    if(t.suit==='wind')return['East','South','West','North'][t.value-1]+' Wind';
    if(t.suit==='dragon')return['Red Dragon (ä¸­)','Green Dragon (ç™¼)','White Dragon (ç™½)'][t.value-1];
    if(t.suit==='flower'){const n=['Spring','Summer','Autumn','Winter','Plum','Orchid','Chrysanthemum','Bamboo Flower'];return n[t.value-1]||'Flower';}
    return '';
  }

  // ===================== FLASH NOTICE =====================
  function showFlash(msg){const el=document.createElement('div');el.style.cssText='position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(192,57,43,0.9);color:#fff;padding:10px 20px;border-radius:30px;font-family:Cinzel,serif;font-size:0.75rem;letter-spacing:0.1em;z-index:9999;pointer-events:none;transition:opacity 0.5s';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.remove(),500);},1800);}

  // ===================== INIT =====================
  buildPalette();
  setSeat('E');
  setRound('E');
</script>
</body>
</html>
